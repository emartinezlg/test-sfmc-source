%%[
/* ============================================
   Journey History Collector - Estimate (AMPscript only)
   Safe for CloudPages (no streaming / no SSJS)
   ============================================ */
   
VAR @clientId, @clientSecret, @authUrl, @restBaseUrl
VAR @accessToken, @authPayload, @authResponse, @authStatus
VAR @currentTime, @yesterday, @yesterdayStart, @yesterdayEnd
VAR @configRows, @rowCount, @i, @journeyId, @journeyName
VAR @estimateEndpoint, @estimatePayload, @authHeader
VAR @estimateStatus, @estimateResponse, @countStart, @countEnd, @estimatedCount
/* === Config === */
SET @clientId     = "c6hbg0vskfdflfwef87nszlo"
SET @clientSecret = "bGF8p8QTtlEKcAK7aJANlY2v"
SET @authUrl      = "https://mcps4dq7y851bybsng90p082fjq0.auth.marketingcloudapis.com/v2/token"
SET @restBaseUrl  = "https://mcps4dq7y851bybsng90p082fjq0.rest.marketingcloudapis.com"
SET @currentTime  = Now()
SET @accountId = "100013802"
/* Target: yesterday UTC day window */
SET @yesterday      = DateAdd(@currentTime, -1, "D")
SET @yesterdayStart = Concat(Format(@yesterday, "yyyy-MM-dd"), "T00:00:00Z")
SET @yesterdayEnd   = Concat(Format(@yesterday, "yyyy-MM-dd"), "T23:59:59Z")
InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note","[CLOUDPAGE] === Starting Journey History Collection ===")
InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] Target Date: ",Format(@yesterday,"yyyy-MM-dd")))
/* === OAuth === */
SET @authPayload = Concat('{"grant_type":"client_credentials","client_id":"', @clientId, '","client_secret":"', @clientSecret,'","account_id":"', @accountId, '"}')
SET @authStatus  = HTTPPost(@authUrl, "application/json", @authPayload, @authResponse)
IF @authStatus == 200 THEN
  VAR @tokenStart, @tokenEnd
  SET @tokenStart  = Add(IndexOf(@authResponse,'":"'), 3)
  Output(concat('@authResponse: ', @authResponse,'<br>'))
  Output(concat('@tokenStart: ', @tokenStart,'<br>'))
  SET @tokenEnd    = IndexOf(@authResponse, '"', @tokenStart)
  Output(concat('@tokenEnd: ', @tokenEnd,'<br>'))
  SET @accessToken = Substring(@authResponse, @tokenStart, "512")
  Output(concat('@accessToken: ', @accessToken,'<br>'))
  InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] ✓ Token obtained. Length: ",@accessToken))
  InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] Token Scopes: ", Substring(@authResponse, 1, 500)))
ELSE
  InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] ✗ AUTH FAILED. Status ", @authStatus, " Response: ", Substring(@authResponse,1,500)))
ENDIF
IF NOT Empty(@accessToken) THEN
  /* Journeys to process */
  SET @configRows = LookupRows("Dashboard_JourneyConfig","Active","1")
  SET @rowCount   = RowCount(@configRows)
  InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] Found ", @rowCount, " active journey(s) to process"))
  IF @rowCount > 0 THEN
    /* Pre-build endpoint + header */
    SET @estimateEndpoint = Concat(@restBaseUrl, "/interaction/v1/interactions/journeyhistory/download")
    SET @authHeader       = Concat("Bearer ", @accessToken)
    Output(concat('@authHeader : ', @authHeader ,'<br>'))
    FOR @i = 1 TO @rowCount DO
      VAR @row
      SET @row        = Row(@configRows, @i)
      SET @journeyId  = Field(@row, "JourneyID")
      SET @journeyName= Field(@row, "JourneyGroupName")
      InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] --- Processing Journey ", @i, "/", @rowCount, " ---"))
      InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] Journey: ", @journeyName, " (", @journeyId, ")"))
      /* Minimal, valid payload (add filters back once stable) */
      SET @estimatePayload = Concat(
        '{',
          '"definitionIds":["', @journeyId, '"],',
          '"start":"', @yesterdayStart, '",',
          '"end":"',   @yesterdayEnd,   '"',
          /* If/when needed, uncomment the next two lines: */
          /* ,'"activityTypes":["trigger"]', */
          /* ,'"statuses":["Complete"]' */
        '}'
      )
      /* Log the exact request */
      InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] DEBUG Endpoint: ", @estimateEndpoint))
      InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] DEBUG Payload: ", Substring(@estimatePayload,1,500)))
      /* Call estimate (only needs Authorization header) */
      SET @estimateStatus = HTTPPost2(@estimateEndpoint, "application/json", @estimatePayload, false, @estimateResponse, @estimateResponseRowset,"Authorization", @authHeader,"x-direct-pipe","true")
      InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] API Status: ", @estimateStatus))
      InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] API Response: ", Substring(@estimateResponse,1,500)))
      IF @estimateStatus == 200 THEN
        /* Extract "rowCount":<num> safely */
        SET @estimatedCount = "0"
        SET @countStart = IndexOf(@estimateResponse, '"rowCount":')
        IF @countStart > 0 THEN
          SET @countStart = Add(@countStart, 11) /* skip "rowCount": */
          SET @countEnd   = IndexOf(@estimateResponse, ",", @countStart)
          IF @countEnd < @countStart THEN
            SET @countEnd = IndexOf(@estimateResponse, "}", @countStart)
          ENDIF
          IF @countEnd > @countStart THEN
            SET @estimatedCount = Substring(@estimateResponse, @countStart, Subtract(@countEnd, @countStart))
            SET @estimatedCount = Replace(@estimatedCount, '"', '')
            SET @estimatedCount = Replace(@estimatedCount, ' ', '')
          ENDIF
        ENDIF
        /* Fallback to 0 if empty */
        IF Empty(@estimatedCount) THEN SET @estimatedCount = "0" ENDIF
        /* Persist */
        InsertDE("Dashboard_JourneyDailyEntries",
          "JourneyID", @journeyId,
          "Date",      @yesterday,
          "DailyEntries", @estimatedCount
        )
        InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] ✓ SUCCESS: ", @estimatedCount, " entries recorded"))
      ELSEIF @estimateStatus == 401 THEN
        InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note","[CLOUDPAGE] ✗ 401 Unauthorized - Token/scopes")
      ELSEIF @estimateStatus == 403 THEN
        InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note","[CLOUDPAGE] ✗ 403 Forbidden - Missing Journey History permission")
      ELSE
        InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] ✗ ERROR: API returned status ", @estimateStatus))
      ENDIF
    NEXT @i
  ELSE
    InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note","[CLOUDPAGE] ⚠ No active journeys found in Dashboard_JourneyConfig")
  ENDIF
ELSE
  InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note","[CLOUDPAGE] ✗ FATAL: No access token available - cannot proceed")
ENDIF
InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note","[CLOUDPAGE] === Collection Process Complete ===")
]%%
