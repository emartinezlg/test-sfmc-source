%%[
/* ============================================
   Journey History Collector - Download (AMPscript only)
   Safe for CloudPages (no streaming / no SSJS)
   ============================================ */
   
VAR @clientId, @clientSecret, @authUrl, @restBaseUrl
VAR @accessToken, @authPayload, @authResponse, @authStatus
VAR @currentTime, @yesterday, @yesterdayStart, @yesterdayEnd
VAR @configRows, @rowCount, @i, @journeyId, @journeyName
VAR @historyEndpoint, @historyPayload, @authHeader
VAR @historyStatus, @historyResponse, @historyResponseRowset
VAR @lineRows, @lineCount, @lineIndex, @line, @normalizedLine
VAR @columnRows, @columnCount, @statusValue, @activityTypeValue
VAR @entryCount, @parsedRows, @debugSampleLimit, @debugLogged
VAR @responseSummary, @journeySummary, @escapedSummary
/* === Config === */
SET @clientId     = "c6hbg0vskfdflfwef87nszlo"
SET @clientSecret = "bGF8p8QTtlEKcAK7aJANlY2v"
SET @authUrl      = "https://mcps4dq7y851bybsng90p082fjq0.auth.marketingcloudapis.com/v2/token"
SET @restBaseUrl  = "https://mcps4dq7y851bybsng90p082fjq0.rest.marketingcloudapis.com"
SET @currentTime  = Now()
SET @accountId = "100013802"
/* Target: yesterday UTC day window */
SET @yesterday      = DateAdd(@currentTime, -1, "D")
SET @yesterdayStart = Concat(Format(@yesterday, "yyyy-MM-dd"), "T00:00:00Z")
SET @yesterdayEnd   = Concat(Format(@yesterday, "yyyy-MM-dd"), "T23:59:59Z")
InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note","[CLOUDPAGE] === Starting Journey History Collection ===")
InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] Target Date: ",Format(@yesterday,"yyyy-MM-dd")))
/* === OAuth === */
SET @authPayload = Concat('{"grant_type":"client_credentials","client_id":"', @clientId, '","client_secret":"', @clientSecret,'","account_id":"', @accountId, '"}')
SET @authStatus  = HTTPPost(@authUrl, "application/json", @authPayload, @authResponse)
IF @authStatus == 200 THEN
  VAR @tokenStart, @tokenEnd
  SET @tokenStart  = Add(IndexOf(@authResponse,'":"'), 3)
  SET @tokenEnd    = IndexOf(@authResponse, '"', @tokenStart)
  SET @accessToken = Substring(@authResponse, @tokenStart, "512")
  InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] ✓ Token obtained. Length: ", Length(@accessToken)))
  InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note","[CLOUDPAGE] Token response received and sanitized for logging")
ELSE
  InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] ✗ AUTH FAILED. Status ", @authStatus, " Response: ", Substring(@authResponse,1,500)))
ENDIF
SET @responseSummary = ""
IF NOT Empty(@accessToken) THEN
  /* Journeys to process */
  SET @configRows = LookupRows("Dashboard_JourneyConfig","Active","1")
  SET @rowCount   = RowCount(@configRows)
  InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] Found ", @rowCount, " active journey(s) to process"))
  IF @rowCount > 0 THEN
    /* Pre-build endpoint + header */
    SET @historyEndpoint = Concat(@restBaseUrl, "/interaction/v1/interactions/journeyhistory/download")
    SET @authHeader       = Concat("Bearer ", @accessToken)
    SET @debugSampleLimit = 5
    FOR @i = 1 TO @rowCount DO
      VAR @row
      SET @row        = Row(@configRows, @i)
      SET @journeyId  = Field(@row, "JourneyID")
      SET @journeyName= Field(@row, "JourneyGroupName")
      InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] --- Processing Journey ", @i, "/", @rowCount, " ---"))
      InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] Journey: ", @journeyName, " (", @journeyId, ")"))
      /* Minimal, valid payload (add filters back once stable) */
      SET @historyPayload = Concat(
        '{',
          '"definitionIds":["', @journeyId, '"],',
          '"start":"', @yesterdayStart, '",',
          '"end":"',   @yesterdayEnd,   '"',
          /* If/when needed, uncomment the next two lines: */
          /* ,'"activityTypes":["trigger"]', */
          /* ,'"statuses":["Complete"]' */
        '}'
      )
      /* Log the exact request */
      InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] DEBUG Endpoint: ", @historyEndpoint))
      InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] DEBUG Payload: ", Substring(@historyPayload,1,500)))
      /* Call download endpoint (only needs Authorization header) */
      SET @historyStatus = HTTPPost2(@historyEndpoint, "application/json", @historyPayload, false, @historyResponse, @historyResponseRowset,"Authorization", @authHeader,"x-direct-pipe","true")
      InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] API Status: ", @historyStatus))
      InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] API Response: ", Substring(@historyResponse,1,500)))
      IF @historyStatus == 200 THEN
        /* Parse CSV lines and count valid entry events */
        SET @entryCount = 0
        SET @parsedRows = 0
        SET @debugLogged = 0
        SET @lineRows = BuildRowsetFromString(@historyResponse, '\n')
        SET @lineCount = RowCount(@lineRows)
        IF @lineCount > 1 THEN
          FOR @lineIndex = 2 TO @lineCount DO
            SET @line = Trim(Replace(Field(Row(@lineRows, @lineIndex), "Field1"), '\r', ''))
            IF NOT Empty(@line) THEN
              SET @normalizedLine = @line
              IF IndexOf(@normalizedLine, '""') > 0 THEN
                SET @normalizedLine = Replace(@normalizedLine, '""', '"')
              ENDIF
              IF IndexOf(@normalizedLine, '","') > 0 THEN
                IF Substring(@normalizedLine, 1, 1) == '"' THEN
                  IF Length(@normalizedLine) > 1 THEN
                    SET @normalizedLine = Substring(@normalizedLine, 2, Subtract(Length(@normalizedLine), 2))
                  ENDIF
                ENDIF
                SET @columnRows = BuildRowsetFromString(@normalizedLine, '","')
              ELSE
                SET @columnRows = BuildRowsetFromString(@normalizedLine, ',')
              ENDIF
              SET @columnCount = RowCount(@columnRows)
              IF @columnCount >= 8 THEN
                SET @statusValue = Lowercase(Trim(Replace(Field(Row(@columnRows, 3), "Field1"), '"', '')))
                SET @activityTypeValue = Lowercase(Trim(Replace(Field(Row(@columnRows, 8), "Field1"), '"', '')))
                SET @parsedRows = Add(@parsedRows, 1)
                IF @debugLogged < @debugSampleLimit THEN
                  InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] DEBUG Row Status=", @statusValue, " ActivityType=", @activityTypeValue))
                  SET @debugLogged = Add(@debugLogged, 1)
                ENDIF
                IF ( @statusValue == "complete" OR @statusValue == "completed" ) AND
                   ( @activityTypeValue == "trigger" OR @activityTypeValue == "journeyentryevent" OR @activityTypeValue == "entryevent" OR @activityTypeValue == "entry" ) THEN
                  SET @entryCount = Add(@entryCount, 1)
                ENDIF
              ENDIF
            ENDIF
          NEXT @lineIndex
        ENDIF
        /* Persist */
        InsertDE("Dashboard_JourneyDailyEntries",
          "JourneyID", @journeyId,
          "Date",      @yesterday,
          "DailyEntries", @entryCount
        )
        InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] ✓ SUCCESS: ", @entryCount, " entries recorded"))
        InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] DEBUG Parsed Rows=", @parsedRows, " Counted Entries=", @entryCount))
        SET @journeySummary = Concat(@journeyName, " (", @journeyId, ") : ", @entryCount, " entries | Rows parsed: ", @parsedRows)
        SET @responseSummary = Concat(@responseSummary, @journeySummary, '\n')
      ELSEIF @historyStatus == 401 THEN
        InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note","[CLOUDPAGE] ✗ 401 Unauthorized - Token/scopes")
        SET @journeySummary = Concat(@journeyName, " (", @journeyId, ") : AUTH 401")
        SET @responseSummary = Concat(@responseSummary, @journeySummary, '\n')
      ELSEIF @historyStatus == 403 THEN
        InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note","[CLOUDPAGE] ✗ 403 Forbidden - Missing Journey History permission")
        SET @journeySummary = Concat(@journeyName, " (", @journeyId, ") : AUTH 403")
        SET @responseSummary = Concat(@responseSummary, @journeySummary, '\n')
      ELSE
        InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note",Concat("[CLOUDPAGE] ✗ ERROR: API returned status ", @historyStatus))
        SET @journeySummary = Concat(@journeyName, " (", @journeyId, ") : API error ", @historyStatus)
        SET @responseSummary = Concat(@responseSummary, @journeySummary, '\n')
      ENDIF
    NEXT @i
  ELSE
    InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note","[CLOUDPAGE] ⚠ No active journeys found in Dashboard_JourneyConfig")
    SET @responseSummary = "No active journeys found."
  ENDIF
ELSE
  InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note","[CLOUDPAGE] ✗ FATAL: No access token available - cannot proceed")
  SET @responseSummary = "Authentication failed."
ENDIF
InsertDE("Dashboard_DailyLog","Date",@currentTime,"Note","[CLOUDPAGE] === Collection Process Complete ===")
IF Empty(@responseSummary) THEN
  SET @responseSummary = "Journey history download completed. No rows returned by API."
ENDIF
SET @escapedSummary = Replace(Replace(@responseSummary,'&','&amp;'),'<','&lt;')
OutputLine(Concat('<html><body><pre>', @escapedSummary, '</pre></body></html>'))
]%%
